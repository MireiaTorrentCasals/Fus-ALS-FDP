---
title: "Data Analysis of 4 samples"
author: "Mireia Torrent"
date: "2024-03-28"
output: html_document
---

```{r setup, include=FALSE}
set.seed(1)

library(Seurat)
library(SeuratObject)
library(tidyverse)
library(Matrix)
library(cowplot) #needed for background_grid
library(kableExtra)
library(patchwork)
library(gridExtra)
library(dplyr)


library(plotly)
library(sctransform)
```

## 1.Load the data and create the Seurat Object
```{r}
WT <- Read10X("WT/")
MyoDicre <- Read10X("MyoDicre/")
FusdNLS <- Read10X("FusdNLS/")
FusdNLS_MyoDicre <- Read10X("FusdNLS_MyoDicre/")
```

```{r}
WT <- CreateSeuratObject(counts = WT, project = "WT", min.cells = 3, min.features = 200)
MyoDicre <- CreateSeuratObject(counts = MyoDicre, project = "MyoDicre", min.cells = 3, min.features = 200)
FusdNLS <- CreateSeuratObject(counts = FusdNLS, project = "FusdNLS", min.cells = 3, min.features = 200)
FusdNLS_MyoDicre <- CreateSeuratObject(counts = FusdNLS_MyoDicre, project = "FusdNLS_MyoDicre", min.cells = 3, min.features = 200)
```

Merge the Seurat Object, passing one dataset in X and the rest as a list in y
```{r}
Seurat_Object <- merge(x = WT, y = c(MyoDicre,FusdNLS, FusdNLS_MyoDicre), add.cell.ids = c("Wt", "MyoDicre","FusdNLS", "FusdNLS_MyoDicre"))

rownames(Seurat_Object)[1:5]
```

## 2.QC, Filtering and Normalization

Seurat allows you to easily explore QC metrics and filter cells based on any user-defined criteria. A few QC metrics commonly used by the community include – The number of unique genes detected in each cell. – Low-quality cells or empty droplets will often have very few genes – Cell doublets or multiplets may exhibit an aberrantly high gene count – Similarly, the total number of molecules detected within a cell (correlates strongly with unique genes)

```{r}
head(Seurat_Object@meta.data,5)
```

```{r}
#On the left we have the barcodes, nCount_RNA is the total number of molecules detected within a droplet using exonic and intronic sequences , nFeature_RNA is the number of detected genes in each droplet using exonic and intronic sequences. 
```

## 3.Visualize number of detected genes and RNA counts

```{r}
# Visualize QC metrics as a violin plot of the features for each sample
plot.violin1 <- VlnPlot(Seurat_Object, features = c("nFeature_RNA"), ncol = 1, pt.size = 0) + background_grid(major = ("xy"), minor = ("y"))

plot.violin1
```
The violinplot shows the gene count distribution of the nuclei. Features: number of genes detected in each nuclei. nCount: total number or molecules detected.

```{r}
plot.violin2 <- VlnPlot(Seurat_Object, features = c("nCount_RNA"), ncol = 1, pt.size = 0) + background_grid(major = ("xy"), minor = ("y"))

plot.violin2
```

The violinplot shows the gene count distribution of the nuclei. Features: number of genes detected in each nuclei. nCount: total number or molecules detected.

## 2.2 Visualize feature-nCount realtionship

```{r}
plot.FeatureRelation <- FeatureScatter(Seurat_Object, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", group.by = "orig.ident")

plot.FeatureRelation
```
```{r}
#make a subset of orig.ident to visualize each sample easier

seurat.subset <- SplitObject(Seurat_Object, split.by = "orig.ident")

plot.wt <- FeatureScatter(seurat.subset$WT, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot.fus <- FeatureScatter(seurat.subset$FusdNLS, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot.myo <- FeatureScatter(seurat.subset$MyoDicre, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot.fusmyo <- FeatureScatter(seurat.subset$FusdNLS_MyoDicre, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
                              
                              
plot.wt+plot.fus+plot.myo+plot.fusmyo
```

## 2.3 Density Plots (ADD IT LATER)


## 2.4 Filter the Data

Take nuclei with a feature number 200/650 and <2500, decide whether proceed with lower bar 200 or 650

```{r}
plot.violin3 <- VlnPlot(Seurat_Object,  features = c("nFeature_RNA"), ncol = 1, pt.size = 0.0001) + background_grid(major = ("xy"), minor = ("y")) + theme(axis.text.x = element_blank()) + geom_hline(yintercept = c(650, 2800), color = "red", linewidth = 0.2)

plot.violin3
```

```{r}
Seurat_Object <- subset(Seurat_Object, subset = nFeature_RNA > 1100 & nFeature_RNA < 3000)

plot.violin5 <- VlnPlot(Seurat_Object,  features = c("nFeature_RNA"), ncol = 1, pt.size = 0.0001) + background_grid(major = ("xy"), minor = ("y")) 
plot.violin5
```

```{r}
plot.violin6 <- VlnPlot(Seurat_Object,  features = c("nFeature_RNA"), ncol = 1, pt.size = 0) + background_grid(major = ("xy"), minor = ("y"))
plot.violin6
```

## 2.5 Dimensions/Nuclei count of the sample in the object

Nuclei count prior the removal of nuclei containing mitochondrial gene transcripts. Establishing samples variable

```{r}
samples <- c("WT", "MyoDicre", "FusdNLS","FusdNLS_MyoDicre")

for (i in seq_along(samples)){
  print(paste("Nuclei count of", samples[[i]], "dataset"))
  print(dim(subset(x = Seurat_Object, subset = orig.ident == (paste(samples[[i]])))))
}
```

## 2.6 Normalize the data

```{r}
Seurat_Object <- NormalizeData(Seurat_Object, normalization.method = "LogNormalize", scale.factor = 10000)
```

##2.7 Identification of Highly Variable genes (feature selection)
```{r}
Seurat_Object <- FindVariableFeatures(Seurat_Object, selection.method = "vst", nfeatures = 2000)
```
Identify top 10 most variable genes. We can do that by performing a mean variability plot. In general, for a gene, the more variability in the counts matrix for each cells the better.The plot identifies features that are outliers on a ‘vst’ or ‘mean variability plot’. This function computes a score for each gene to select the 2000 bests for the next step, the PCA

```{r}
top10 <- head(VariableFeatures(Seurat_Object),10)
top10
```
```{r}
plot.volcano.wo.labels <- VariableFeaturePlot(Seurat_Object)

plot.volcano.labels <- LabelPoints(plot = plot.volcano.wo.labels, points = top10, repel = TRUE)
plot.volcano.wo.labels
plot.volcano.labels
```

#2.8 Scaling the Data
```{r}
all.genes <- rownames(Seurat_Object)
Seurat_Object <- ScaleData(Seurat_Object, features = all.genes)

```








